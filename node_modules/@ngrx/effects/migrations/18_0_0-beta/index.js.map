{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../../modules/effects/migrations/18_0_0-beta/index.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAiBA,sEA4HC;AA8BD,4BAEC;AA7KD,+CAAiC;AACjC,2DAKoC;AACpC,2DAO+B;AAC/B,iEAA0E;AAE1E,SAAgB,6BAA6B;IAC3C,OAAO,CAAC,IAAU,EAAE,GAAqB,EAAE,EAAE;QAC3C,IAAA,yCAAuB,EAAC,IAAI,EAAE,cAAc,EAAE,iBAAiB,EAAE,SAAS,CAAC,CAAC;QAE5E,IAAA,oCAAkB,EAAC,IAAI,EAAE,CAAC,UAAU,EAAE,EAAE;YACtC,MAAM,kBAAkB,GAAG,IAAI,KAAK,EAAwB,CAAC;YAE7D,qBAAqB,CAAC,UAAU,EAAE,kBAAkB,CAAC,CAAC;YAEtD,MAAM,6BAA6B,GAAG,kBAAkB;iBACrD,GAAG,CAAC,CAAC,wBAAwB,EAAE,EAAE;gBAChC,MAAM,cAAc,GAAG,sBAAsB,CAC3C,wBAAwB,CACzB,CAAC;gBACF,IAAI,cAAc,EAAE,CAAC;oBACnB,IACE,cAAc,CAAC,QAAQ,CAAC,IAAI,CAC1B,CAAC,OAAO,EAAE,EAAE,CAAC,OAAO,CAAC,IAAI,CAAC,OAAO,EAAE,KAAK,kBAAkB,CAC3D,EACD,CAAC;wBACD,OAAO,EAAE,cAAc,EAAE,wBAAwB,EAAE,CAAC;oBACtD,CAAC;oBACD,OAAO,SAAS,CAAC;gBACnB,CAAC;qBAAM,CAAC;oBACN,OAAO,SAAS,CAAC;gBACnB,CAAC;YACH,CAAC,CAAC;iBACD,MAAM,CAAC,OAAO,CAAC,CAAC;YAEnB,IAAI,6BAA6B,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;gBAC/C,OAAO;YACT,CAAC;iBAAM,IAAI,6BAA6B,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;gBACpD,GAAG,CAAC,MAAM,CAAC,IAAI,CACb,yEAAyE,CAC1E,CAAC;gBACF,OAAO;YACT,CAAC;YAED,MAAM,CAAC,4BAA4B,CAAC,GAAG,6BAA6B,CAAC;YACrE,IAAI,CAAC,4BAA4B,EAAE,CAAC;gBAClC,OAAO;YACT,CAAC;YAED,MAAM,EAAE,cAAc,EAAE,wBAAwB,EAAE,GAChD,4BAA4B,CAAC;YAE/B,MAAM,0BAA0B,GAAG,kBAAkB,CAAC,IAAI,CAAC,CAAC,IAAI,EAAE,EAAE,CAClE,IAAI,CAAC,eAAe,CAAC,OAAO,EAAE,CAAC,QAAQ,CAAC,iBAAiB,CAAC,CAC3D,CAAC;YAEF,MAAM,mBAAmB,GAAG,cAAc,CAAC,QAAQ;iBAChD,MAAM,CAAC,CAAC,OAAO,EAAE,EAAE,CAAC,OAAO,CAAC,IAAI,CAAC,OAAO,EAAE,KAAK,kBAAkB,CAAC;iBAClE,GAAG,CAAC,CAAC,OAAO,EAAE,EAAE,CAAC,OAAO,CAAC,IAAI,CAAC,OAAO,EAAE,CAAC;iBACxC,IAAI,CAAC,IAAI,CAAC,CAAC;YAEd,MAAM,OAAO,GAAa,EAAE,CAAC;YAC7B,2EAA2E;YAC3E,IAAI,mBAAmB,EAAE,CAAC;gBACxB,OAAO,CAAC,IAAI,CACV,IAAA,qCAAmB,EACjB,UAAU,EACV,wBAAwB,EACxB,wBAAwB,CAAC,OAAO,EAAE,EAClC,YAAY,mBAAmB,0BAA0B,CAC1D,CACF,CAAC;YACJ,CAAC;YACD,mFAAmF;iBAC9E,CAAC;gBACJ,OAAO,CAAC,IAAI,CACV,IAAA,2BAAkB,EAChB,UAAU,EACV,wBAAwB,EACxB,wBAAwB,CAAC,QAAQ,EAAE,EACnC,wBAAwB,CAAC,MAAM,EAAE,GAAG,CAAC,CACtC,CACF,CAAC;YACJ,CAAC;YAED,IAAI,mCAAmC,GAAG,KAAK,CAAC;YAChD,IAAI,0BAA0B,EAAE,YAAY,EAAE,aAAa,EAAE,CAAC;gBAC5D,MAAM,QAAQ,GAAG,0BAA0B,CAAC,YAAY,CAAC,aAAa,CAAC;gBACvE,IAAI,EAAE,CAAC,cAAc,CAAC,QAAQ,CAAC,EAAE,CAAC;oBAChC,yCAAyC;oBACzC,MAAM,cAAc,GAAG;wBACrB,GAAG,QAAQ,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC,OAAO,EAAE,EAAE,CAAC,OAAO,CAAC,IAAI,CAAC,OAAO,EAAE,CAAC;wBAC7D,kBAAkB;qBACnB,CAAC;oBACF,MAAM,kBAAkB,GAAG,YAAY,cAAc,CAAC,IAAI,CACxD,IAAI,CACL,4BAA4B,CAAC;oBAC9B,OAAO,CAAC,IAAI,CACV,IAAA,qCAAmB,EACjB,UAAU,EACV,0BAA0B,EAC1B,0BAA0B,CAAC,OAAO,EAAE,EACpC,kBAAkB,CACnB,CACF,CAAC;oBACF,mCAAmC,GAAG,IAAI,CAAC;gBAC7C,CAAC;YACH,CAAC;YAED,IAAI,CAAC,mCAAmC,EAAE,CAAC;gBACzC,sCAAsC;gBACtC,MAAM,kBAAkB,GAAG,qDAAqD,CAAC;gBACjF,OAAO,CAAC,IAAI,CACV,IAAI,8BAAY,CACd,UAAU,CAAC,QAAQ,EACnB,wBAAwB,CAAC,MAAM,EAAE,GAAG,CAAC,EACrC,GAAG,kBAAkB,IAAI,CAAC,wCAAwC;iBACnE,CACF,CAAC;YACJ,CAAC;YAED,IAAA,+BAAa,EAAC,IAAI,EAAE,UAAU,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAC;YAElD,IAAI,OAAO,CAAC,MAAM,EAAE,CAAC;gBACnB,GAAG,CAAC,MAAM,CAAC,IAAI,CACb,2EAA2E,CAC5E,CAAC;YACJ,CAAC;QACH,CAAC,CAAC,CAAC;IACL,CAAC,CAAC;AACJ,CAAC;AAED,SAAS,qBAAqB,CAC5B,IAAa,EACb,OAA+B;IAE/B,IAAI,EAAE,CAAC,mBAAmB,CAAC,IAAI,CAAC,EAAE,CAAC;QACjC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;IACrB,CAAC;IAED,EAAE,CAAC,YAAY,CAAC,IAAI,EAAE,CAAC,SAAS,EAAE,EAAE,CAClC,qBAAqB,CAAC,SAAS,EAAE,OAAO,CAAC,CAC1C,CAAC;AACJ,CAAC;AAED,SAAS,sBAAsB,CAC7B,IAA0B;IAE1B,MAAM,aAAa,GAAG,IAAI,EAAE,YAAY,EAAE,aAAa,CAAC;IACxD,IACE,IAAI,CAAC,eAAe,CAAC,OAAO,EAAE,CAAC,QAAQ,CAAC,eAAe,CAAC;QACxD,aAAa;QACb,EAAE,CAAC,cAAc,CAAC,aAAa,CAAC,EAChC,CAAC;QACD,OAAO,aAAa,CAAC;IACvB,CAAC;IAED,OAAO,IAAI,CAAC;AACd,CAAC;AAED;IACE,OAAO,IAAA,kBAAK,EAAC,CAAC,6BAA6B,EAAE,CAAC,CAAC,CAAC;AAClD,CAAC","sourcesContent":["import * as ts from 'typescript';\nimport {\n  Tree,\n  Rule,\n  chain,\n  SchematicContext,\n} from '@angular-devkit/schematics';\nimport {\n  addPackageToPackageJson,\n  Change,\n  commitChanges,\n  createReplaceChange,\n  InsertChange,\n  visitTSSourceFiles,\n} from '../../schematics-core';\nimport { createRemoveChange } from '../../schematics-core/utility/change';\n\nexport function migrateConcatLatestFromImport(): Rule {\n  return (tree: Tree, ctx: SchematicContext) => {\n    addPackageToPackageJson(tree, 'dependencies', '@ngrx/operators', '^18.0.0');\n\n    visitTSSourceFiles(tree, (sourceFile) => {\n      const importDeclarations = new Array<ts.ImportDeclaration>();\n\n      getImportDeclarations(sourceFile, importDeclarations);\n\n      const effectsImportsAndDeclarations = importDeclarations\n        .map((effectsImportDeclaration) => {\n          const effectsImports = getEffectsNamedBinding(\n            effectsImportDeclaration\n          );\n          if (effectsImports) {\n            if (\n              effectsImports.elements.some(\n                (element) => element.name.getText() === 'concatLatestFrom'\n              )\n            ) {\n              return { effectsImports, effectsImportDeclaration };\n            }\n            return undefined;\n          } else {\n            return undefined;\n          }\n        })\n        .filter(Boolean);\n\n      if (effectsImportsAndDeclarations.length === 0) {\n        return;\n      } else if (effectsImportsAndDeclarations.length > 1) {\n        ctx.logger.info(\n          '[@ngrx/effects] Skipping because of multiple `concatLatestFrom` imports'\n        );\n        return;\n      }\n\n      const [effectsImportsAndDeclaration] = effectsImportsAndDeclarations;\n      if (!effectsImportsAndDeclaration) {\n        return;\n      }\n\n      const { effectsImports, effectsImportDeclaration } =\n        effectsImportsAndDeclaration;\n\n      const operatorsImportDeclaration = importDeclarations.find((node) =>\n        node.moduleSpecifier.getText().includes('@ngrx/operators')\n      );\n\n      const otherEffectsImports = effectsImports.elements\n        .filter((element) => element.name.getText() !== 'concatLatestFrom')\n        .map((element) => element.name.getText())\n        .join(', ');\n\n      const changes: Change[] = [];\n      // Remove `concatLatestFrom` from @ngrx/effects and leave the other imports\n      if (otherEffectsImports) {\n        changes.push(\n          createReplaceChange(\n            sourceFile,\n            effectsImportDeclaration,\n            effectsImportDeclaration.getText(),\n            `import { ${otherEffectsImports} } from '@ngrx/effects';`\n          )\n        );\n      }\n      // Remove complete @ngrx/effects import because it contains only `concatLatestFrom`\n      else {\n        changes.push(\n          createRemoveChange(\n            sourceFile,\n            effectsImportDeclaration,\n            effectsImportDeclaration.getStart(),\n            effectsImportDeclaration.getEnd() + 1\n          )\n        );\n      }\n\n      let importAppendedInExistingDeclaration = false;\n      if (operatorsImportDeclaration?.importClause?.namedBindings) {\n        const bindings = operatorsImportDeclaration.importClause.namedBindings;\n        if (ts.isNamedImports(bindings)) {\n          // Add import to existing @ngrx/operators\n          const updatedImports = [\n            ...bindings.elements.map((element) => element.name.getText()),\n            'concatLatestFrom',\n          ];\n          const newOperatorsImport = `import { ${updatedImports.join(\n            ', '\n          )} } from '@ngrx/operators';`;\n          changes.push(\n            createReplaceChange(\n              sourceFile,\n              operatorsImportDeclaration,\n              operatorsImportDeclaration.getText(),\n              newOperatorsImport\n            )\n          );\n          importAppendedInExistingDeclaration = true;\n        }\n      }\n\n      if (!importAppendedInExistingDeclaration) {\n        // Add new @ngrx/operators import line\n        const newOperatorsImport = `import { concatLatestFrom } from '@ngrx/operators';`;\n        changes.push(\n          new InsertChange(\n            sourceFile.fileName,\n            effectsImportDeclaration.getEnd() + 1,\n            `${newOperatorsImport}\\n` // not os-independent for snapshot tests\n          )\n        );\n      }\n\n      commitChanges(tree, sourceFile.fileName, changes);\n\n      if (changes.length) {\n        ctx.logger.info(\n          `[@ngrx/effects] Updated concatLatestFrom to import from '@ngrx/operators'`\n        );\n      }\n    });\n  };\n}\n\nfunction getImportDeclarations(\n  node: ts.Node,\n  imports: ts.ImportDeclaration[]\n): void {\n  if (ts.isImportDeclaration(node)) {\n    imports.push(node);\n  }\n\n  ts.forEachChild(node, (childNode) =>\n    getImportDeclarations(childNode, imports)\n  );\n}\n\nfunction getEffectsNamedBinding(\n  node: ts.ImportDeclaration\n): ts.NamedImports | null {\n  const namedBindings = node?.importClause?.namedBindings;\n  if (\n    node.moduleSpecifier.getText().includes('@ngrx/effects') &&\n    namedBindings &&\n    ts.isNamedImports(namedBindings)\n  ) {\n    return namedBindings;\n  }\n\n  return null;\n}\n\nexport default function (): Rule {\n  return chain([migrateConcatLatestFromImport()]);\n}\n"]}